---
import { Code } from 'astro:components';

interface Props {
  code: string;
  filename: string;
  lang?: string;
}

const { code, filename, lang = 'typescript' } = Astro.props;
---

<div class="not-prose my-6 rounded-lg border border-gray-200 dark:border-gray-800 overflow-hidden" data-codeblock>
  <div class="flex items-center gap-2 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900 px-4 py-2.5">
    <svg class="h-3.5 w-3.5 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <span class="text-xs font-medium text-gray-600 dark:text-gray-400">{filename}</span>
    <button data-fullscreen-toggle class="ml-auto shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors cursor-pointer" title="Toggle fullscreen">
      <svg data-icon-expand class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9m11.25-5.25v4.5m0-4.5h-4.5m4.5 0L15 9m-11.25 11.25v-4.5m0 4.5h4.5m-4.5 0L9 15m11.25 5.25v-4.5m0 4.5h-4.5m4.5 0L15 15" />
      </svg>
      <svg data-icon-collapse class="h-4 w-4 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
  <div class="overflow-auto max-h-[32rem]" data-code-panel>
    <Code code={code.trim()} lang={lang} theme="one-dark-pro" />
  </div>
</div>

<script>
  function initCodeBlocks() {
    document.querySelectorAll('[data-codeblock]').forEach((container) => {
      const fsToggle = container.querySelector<HTMLButtonElement>('[data-fullscreen-toggle]');
      const iconExpand = container.querySelector<SVGElement>('[data-icon-expand]');
      const iconCollapse = container.querySelector<SVGElement>('[data-icon-collapse]');

      function toggleFullscreen() {
        const isFullscreen = container.classList.toggle('code-fullscreen');
        iconExpand?.classList.toggle('hidden', isFullscreen);
        iconCollapse?.classList.toggle('hidden', !isFullscreen);
        document.documentElement.classList.toggle('overflow-hidden', isFullscreen);
      }

      fsToggle?.addEventListener('click', toggleFullscreen);

      container.addEventListener('keydown', (e: Event) => {
        if ((e as KeyboardEvent).key === 'Escape' && container.classList.contains('code-fullscreen')) {
          toggleFullscreen();
        }
      });
    });
  }

  initCodeBlocks();
  document.addEventListener('astro:after-swap', initCodeBlocks);
</script>
